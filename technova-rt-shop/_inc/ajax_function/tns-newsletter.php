<?phpadd_action('wp_ajax_nopriv_tns_newsletter','tns_newsletter');add_action('wp_ajax_tns_newsletter','tns_newsletter');function tns_newsletter() {	if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'])){		die('access deind');	}	$email = sanitize_text_field($_POST['email']);	tns_validate_input($email);	tns_is_user_subscribe($email);	tns_insert_newsletter($email);}// VALIDATEfunction tns_validate_input($email) {	if (empty($email)){		wp_send_json(['error'=>true,'message'=>'ایمیل خود را وارد کنید!'],403);	}	if (!is_email($email)){		wp_send_json(['error'=>true,'message'=>'لطفا یک ایمیل معتبر وارد کنید!'],403);	}}// INSERT USERfunction tns_insert_newsletter($email) {	global $wpdb;	$table = $wpdb->prefix . 'tns_newsletter';	$data = ['email' => $email];	$format = ['%s'];	$stmt = $wpdb->insert($table,$data,$format);	if ($stmt !== false){		wp_send_json( [ 'success' => true, 'message' => 'شما در خبرنامه عضو شدید!' ], 200 );	}else{		wp_send_json( [ 'error' => true, 'message' => 'مشکلی در ذخیره‌سازی ایمیل به وجود آمد.' ], 403 );	}}// IS USER SUBSCRIBEfunction tns_is_user_subscribe($email) {	global $wpdb;	$table = $wpdb->prefix . 'tns_newsletter';	$stmt  = $wpdb->get_row( $wpdb->prepare( "SELECT email FROM {$table} WHERE email = '%s'", $email ) );	if ( $stmt ) {		wp_send_json( [ 'error' => true, 'message' => 'این ایمیل قبلا ثبت شده است !' ], 403 );	}}// GET_USER_SUBSCRIBEfunction tns_get_user_subscribe(): array {    global $wpdb;    $table = $wpdb->prefix . 'tns_newsletter';    $results = $wpdb->get_col( "SELECT email FROM {$table}" );    return $results;}// GET_RECENT_POSTfunction tns_get_recent_post() {    $args         = [        'posts_per_page' => 1,        'post_type'      => [ 'post' ],        'meta_key'       => '_tns_send_post_newsletter',        'meta_value'     => '1',        'post_status'    => 'publish',        'orderby'        => 'post_date',        'order'          => 'DESC'    ];    $recent_posts = get_posts( $args );    if ( $recent_posts ):        foreach ( $recent_posts as $recent_post ):            if ( empty( get_post_meta( $recent_post->ID, '_tnw_category_post', true ) ) ):                $cat_html = '<a href="#" class="badge text-bg-danger mb-2"><i class="fas fa-circle me-2 small fw-bold"></i>لطفا دسته بندی مورد نظر از طریق متا باکس موجود انتخاب کنید!!</a>';            else:                $cat_id   = get_post_meta( $recent_post->ID, '_tnw_category_post', true );                $cat_name = get_the_category_by_ID( $cat_id );                $cat_link = get_category_link( $cat_id );                $cat_html = '<a href=" ' . $cat_link . ' ?>" class="badge text-bg-warning mb-2"><i class="fas fa-circle me-2 small fw-bold"></i> ' . $cat_name . '</a>';            endif;            $id_or_email =  get_the_author_meta('email');            $avatar =  get_avatar($id_or_email,'39','robohash',get_the_author(),['class'=>'avatar-img rounded-circle']);            if (has_post_thumbnail($recent_post->ID)):                $image_html = get_the_post_thumbnail($recent_post->ID,'medium',['class'=> 'rounded-3']);            endif;            $excerpt = has_excerpt($recent_post->ID) ? get_the_excerpt($recent_post->ID) : wp_trim_words($recent_post->post_content, 40);            return '<div class="card border rounded-3 up-hover p-4 mb-4">	<div class="row g-3">		<div class="col-sm-9">			<!-- Categories -->			' . $cat_html . ';				<!-- Title -->			<h4 class="card-title">				<a href="' . get_the_permalink($recent_post->ID) . '" class="btn-link text-reset stretched-link">' .$recent_post->post_title. '</a>			</h4>			<!-- Card info -->			<ul class="nav nav-divider align-items-center d-none d-sm-inline-block">				<li class="nav-item">					<div class="nav-link">						<div class="d-flex align-items-center position-relative">							<div class="avatar avatar-xs">							'.$avatar.'		                    </div>		                    <span class="ms-3">با <a href="#" class="stretched-link text-reset btn-link"> '.get_the_author().'</a></span>						</div>					</div>				</li>				<li class="nav-item"> '.get_the_date('j ,F Y').'</li>                <li class="nav-item"><span class="fa fa-comment"></span>  '.get_comments_number().'  </li>			</ul>		</div>		<!-- Detail -->		<div class="col-md-6 col-lg-4">			<p>'.$excerpt.'</p>		</div>		<!-- Image -->		<div class="col-md-6 col-lg-3">			'.$image_html.'		</div>	</div>	</div></div>';        endforeach;    endif;}// POST_SEND_MAIL()add_action('publish_post','tns_post_send_mail');function tns_post_send_mail() {    $headers  = ['Content-Type: text/html; charset=UTF-8'];    $email_to = tns_get_user_subscribe();    $subject  = 'خبرنامه';    $message  = tns_get_recent_post();    if ( ! empty( $email_to ) && is_array( $email_to ) ) {        foreach ( $email_to as $email ) {            wp_mail( $email, $subject, $message, $headers );        }    }}